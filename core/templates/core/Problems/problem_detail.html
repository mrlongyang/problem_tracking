{% extends "core/Main/base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/problem_detail.css' %}">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div id="themeToggleWrapper" class="position-fixed top-0 end-0 p-3 z-3">
  <div class="form-check form-switch">
    <input class="form-check-input" type="checkbox" id="themeToggle">
    <label class="form-check-label text-dark" for="themeToggle">üåô Dark Mode</label>
  </div>
</div>


<div class="container py-4">
  <div class="card shadow-lg">
    <div class="card-body">
      <h4 class="card-title text-primary">{{ problem.title }}</h4>
      <p><strong>Module:</strong> {{ problem.module.module_name|default:"‚Äî" }}</p>
      <p>
        <span class="badge bg-warning text-dark">Status: {{ problem.status }}</span>
        <span class="badge bg-info text-dark">Priority: {{ problem.priority }}</span>
      </p>
      <p><strong>Department:</strong> {{ problem.department.department_name }}</p>
      <p><strong>Description:</strong><br> {{ problem.description|linebreaks }}</p>
      <p class="text-muted">
        <strong>Created by:</strong> {{ problem.created_at|date:"F j, Y, g:i a" }}
      </p>
    </div>
  </div>

  <div class="mt-4">
    <h4>üìé Attachments:</h4>
    <ul class="list-group list-group-flush">
      {% for att in problem.problemattachment_set.all %}
      <li class="list-group-item">
        {% if att.file.url %}
        <a href="{{ att.file.url }}" target="_blank">{{ att.file.name }}</a>
        {% else %}
        [No file]
        {% endif %}
      </li>
      {% empty %}
      <li class="list-group-item text-muted">No attachments.</li>
      {% endfor %}
    </ul>
  </div>

  <div class="mt-4">
    <h4>üí° Solutions:</h4>
    {% for solution in solutions %}
    <div class="card border-success mb-3">
      <div class="card-body">
        <p class="card-text">{{ solution.content }}</p>
        <small class="text-muted">By {{ solution.author.name }} on {{ solution.created_at }}</small>
        <ul class="mt-2">
          {% for attachment in solution.attachments.all %}
          <li><a href="{{ attachment.file.url }}" target="_blank">üìé Attachment</a></li>
          {% empty %}
          <li>No attachments.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% empty %}
    <p class="text-muted">No solutions yet.</p>
    {% endfor %}
  </div>

  <p><strong>Solutions:</strong> {{ problem.solutions.count }}</p>
  <div class="mt-5">
    <h5>üìù Submit Your Solution</h5>
    <form method="post" enctype="multipart/form-data" class="bg-light p-4 rounded shadow-sm"
      onsubmit="return showSubmitMessage()">
      {% csrf_token %}
      {{ form.as_p }}
      <label class="form-label">Attach Files:</label>
      <input type="file" name="attachments" multiple class="form-control mb-3">
      <button type="submit" class="btn btn-success">‚úÖ Submit Solution</button>
    </form>


    <div class="mt-3">
      <a href="{% url 'problem_list' %}" class="btn btn-secondary">üîô Back to List</a>
    </div>
  </div>

  {% if messages %}
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
    {% for message in messages %}
    <div class="toast align-items-center text-white bg-success border-0 show" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          {{ message }}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}


  <script>
    function showSubmitMessage() {
      alert("‚úÖ Submit solution successful! Thank you.");
      return true;
    }
  </script>

  <script>
    window.addEventListener("DOMContentLoaded", function () {
      const toastElList = [].slice.call(document.querySelectorAll('.toast'));
      toastElList.map(function (toastEl) {
        return new bootstrap.Toast(toastEl, { delay: 4000 }).show();
      });
    });
  </script>


  <script>
    const toggle = document.getElementById('themeToggle');
    const body = document.body;

    toggle.addEventListener('change', function () {
      if (this.checked) {
        body.classList.add('dark-mode');
      } else {
        body.classList.remove('dark-mode');
      }
    });
  </script>

  {% endblock %}