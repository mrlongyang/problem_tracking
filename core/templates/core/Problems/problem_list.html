{% extends "core/Main/base.html" %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="{% static 'core/css/fonts.css' %}">
<link rel="stylesheet" href="{% static 'core/css/problem_list.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .error-id-text {
    font-weight: bold;
  }

  .error-description-text {
    text-transform: uppercase;
    color: #007bff;
    /* Blue color */
    font-weight: bold;
    /* text-align: justify; <--- REMOVE THIS LINE */
    text-align: left;
    /* Or just let it be the default */
  }

  .error-details-text {
    text-transform: lowercase;
    color: #28a745;
    /* Green color */
    /* text-align: justify; <--- REMOVE THIS LINE */
    text-align: left;
    /* Or just let it be the default */
    font-weight: bold;
  }

  /* Optional: To add the brackets [] as seen in the image */
  .error-description-text a::before {
    content: "";
  }

  .error-description-text a::after {
    content: "";
  }
</style>

<div class="sticky-top bg-white shadow-sm py-2 z-3">
  <div class="container">
    <div class="row align-items-center gy-3">

      <!-- Left Section: Form -->
      <div class="col-12 col-lg-5">
        <form method="get" class="d-flex flex-wrap align-items-center gap-2">
          <a href="{% url 'problem_create' %}" class="btn btn-primary px-3" style="white-space: nowrap; font-family: Phetsarath OT;">
            ‚ûï&nbsp;‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ö‡∫±‡∫ô‡∫´‡∫≤‡ªÉ‡ªù‡ªà
          </a>
          <input type="text" name="search" class="form-control flex-grow-1" placeholder="‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤‡∫ö‡∫±‡∫ô‡∫´‡∫≤ ..." value="{{ search_query }}" style="font-family: Phetsarath OT; min-width: 200px;">
        </form>
      </div>

      <!-- Center Section: Daily Report -->
      <div class="col-12 col-lg-3">
        <h6>üèÜ Top Modules with Most Problems:</h6>
        <ul class="list-group mb-2">
          {% for item in daily_report %}
          <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
            {{ item.created_date }}
            <span class="badge bg-primary rounded-pill">{{ item.count }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Right Section: Filter, Notification, Profile -->
      <div class="col-12 col-lg-4">
        <div class="d-flex flex-wrap justify-content-end gap-2">

          <!-- Status Buttons -->
          <div class="btn-group">
            <a href="{% url 'problem_list' %}" class="btn btn-outline-dark {% if not selected_status %}active{% endif %}">All</a>
            <a href="?status=open{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-danger {% if selected_status == 'open' %}active{% endif %}">Open üü•</a>
            <a href="?status=resolved{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-success {% if selected_status == 'resolved' %}active{% endif %}">Resolved ‚úÖ</a>
          </div>

          <!-- Priority Dropdown -->
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              {% if selected_priority %}Sort by: {{ selected_priority }}{% else %}Sort by: All{% endif %}
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="?{% if search_query %}search={{ search_query }}&{% endif %}">All</a></li>
              <li><a class="dropdown-item" href="?priority=Critical{% if search_query %}&search={{ search_query }}{% endif %}">Critical</a></li>
              <li><a class="dropdown-item" href="?priority=High{% if search_query %}&search={{ search_query }}{% endif %}">High</a></li>
              <li><a class="dropdown-item" href="?priority=Medium{% if search_query %}&search={{ search_query }}{% endif %}">Medium</a></li>
              <li><a class="dropdown-item" href="?priority=Low{% if search_query %}&search={{ search_query }}{% endif %}">Low</a></li>
            </ul>
          </div>

          <!-- Notification -->
          <a class="nav-link position-relative" href="{{ latest_problem_link }}" style="font-family: Phetsarath OT;">
            üîî ‡∫Å‡∫≤‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô
            {% if notification_count > 0 %}
            <span class="notification-badge">{{ notification_count }}</span>
            {% endif %}
          </a>

          <!-- Profile -->
          <div class="profile-menu">
            <img src="{% static 'core/images/apb.jpg' %}" id="profileIcon" alt="Profile">
            <div class="profile-dropdown" id="profileDropdown">
              <a href="{% url 'profile_view' %}">‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå</a>
              <a href="{% url 'login' %}" onclick="confirmLogout(event)">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</a>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>


<table class="table table-striped" id="problemTable">
  <thead>
    <tr>
      <th>Error Problem ID:</th>
      <th>Error Description:</th>
      <th>Error Details:</th>
      <th>Module:</th>
      <th>Status:</th>
      <th>Priority:</th>
      <th>Department:</th>
      <th>Last Updated:</th>
    </tr>
  </thead>
  <tbody id="problemTableBody">
    {% for problem in page_obj %}
    <tr>
      <td class="error-id-text">{{ problem.problem_id }}</td>
      <td class="error-description-text">
        <a href="{% url 'problem_detail' problem_id=problem.problem_id %}">{{ problem.title }}</a>
      </td>
      <td class="error-details-text">{{ problem.description }}</td>
      <td>{{ problem.module.module_name }}</td>
      <td>{{ problem.status }}</td>
      <td>{{ problem.priority }}</td>
      <td>{{ problem.department.department_name }}</td>
      <td>{{ problem.updated_at|date:"SHORT_DATETIME_FORMAT" }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>


<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link"
        href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}">
        <span style="font-family: 'Phetsarath OT', sans-serif;">‚èÆÔ∏è ‡ªú‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô‡∫´‡∫ô‡ªâ‡∫≤‡∫ô‡∫µ‡ªâ</span></a>
    </li>

    {% endif %}

    {% for num in page_obj.paginator.page_range %}
    {% if page_obj.number == num %}
    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
    {% else %}
    <li class="page-item">
      <a class="page-link"
        href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}">
        {{ num }}
      </a>
    </li>
    {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link"
        href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}">
        <span style="font-family: 'Phetsarath OT', sans-serif;">‡ªú‡ªâ‡∫≤‡∫ï‡ªç‡ªà‡ªÑ‡∫õ ‚è≠Ô∏è</span></a>
    </li>
    {% endif %}
  </ul>
</nav>

<script>
  const searchInput = document.querySelector('input[name="search"]');
  const tableBody = document.getElementById('problemTableBody');
  searchInput.addEventListener('input', function () {
    const query = this.value;
    fetch(`/ajax/search-problems/?search=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        tableBody.innerHTML = data.html;
      });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'core/js/problem_list.js' %}"></script>

<!-- Hidden logout form -->
<form id="logoutForm" method="post" action="{% url 'logout' %}" style="display: none;">
  {% csrf_token %}
</form>

{% if messages %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="{% static 'core/css/fonts.css' %}">

{% for message in messages %}
<script>
  Swal.fire({
    icon: 'success',
    text: "{{ message|escapejs }}",
    confirmButtonText: 'OK'
  });
</script>
{% endfor %}
{% endif %}

{% endblock %}