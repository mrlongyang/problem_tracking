{% load static %}
<!DOCTYPE html>
<html lang="lo">

<head>
     <meta charset="UTF-8">
     <title>Problem Lists</title>
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap & Fonts -->
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
     <link rel="stylesheet" href="{% static 'core/css/fonts.css' %}">
     <link rel="icon" type="image/png" href="{% static 'core/images/logoo.png' %}">
     <link rel="stylesheet" href="{% static 'core/css/problem_list_standalone.css' %}">

     <style>
          .sidebar {
               border-right: 1px solid #ccc;
               height: 150vh;
               position: sticky;
               top: 70px;
               height: fit-content;
          }

          .dropdown-menu .dropdown-item:hover {
               background-color: #f8f9fa !important;
               color: black !important;
          }

          .dropdown-menu .dropdown-item:active {
               background-color: #f8f9fa !important;
               color: black !important;
          }
     </style>

</head>

<body>
     <div class="container-fluid">

          <div class="sticky-top bg-white py-2 px-3 border-bottom z-3" style="top: 0;">
               <div class="row align-items-center">

                    <!-- üîò Create Button -->
                    <div class="col-auto mb-2 mb-md-0">
                         <a href="{% url 'problem_create' %}" class="btn btn-primary btn-sm"
                         style="font-family: Phetsarath OT;">‚ûï ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡∫ö‡∫±‡∫ô‡∫´‡∫≤‡ªÉ‡ªù‡ªà</a>
                    </div>

                    <!-- üîç Search -->
                    <div class="col text-center mb-2 mb-md-0">
                         <form method="get" class="d-inline-flex align-items-center gap-2 w-100"
                              style="max-width: 500px;">
                              <input type="text" id="liveSearch" name="search"
                                   class="form-control form-control-sm w-100" placeholder="üîç ‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤ ..."
                                   autocomplete="off">
                              <button type="submit" class="btn btn-outline-secondary btn-sm">‡∫Ñ‡∫ª‡ªâ‡∫ô‡∫´‡∫≤</button>
                         </form>
                    </div>

                    <!-- üîî Notification -->
                    <div class="col-auto mb-2 mb-md-0">
                         <a class="nav-link position-relative ms-3" href="{{ latest_problem_link }}"
                              style="font-family: Phetsarath OT;">
                              üîî ‡∫Å‡∫≤‡∫ô‡ªÅ‡∫à‡ªâ‡∫á‡ªÄ‡∫ï‡∫∑‡∫≠‡∫ô
                              {% if notification_count > 0 %}
                              <span class="notification-badge" style="font-family: Phetsarath OT;">
                                   {{ notification_count }}
                              </span>
                              {% endif %}
                         </a>
                    </div>

                    <!-- üë§ Profile Dropdown -->
                    <div class="col-auto position-relative mb-2 mb-md-0">
                         <img src="{% static 'core/images/apb.jpg' %}" id="profileIcon" alt="Profile"
                              class="rounded-circle" width="36" style="cursor: pointer;">
                         <div class="position-absolute bg-white border shadow-sm rounded px-2 py-2 mt-2"
                              id="profileDropdown" style="right: 0; display: none; z-index: 999;">
                              <a href="{% url 'profile_view' %}" class="dropdown-item small">üë§ ‡ªÇ‡∫õ‡∫£‡ªÑ‡∫ü‡∫•‡ªå</a>
                              <a href="{% url 'logout' %}" onclick="showLogoutModal(event)" class="dropdown-item small">üö™ ‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</a>
                         </div>
                    </div>

               </div>
          </div>

          <div class="row">

               <!-- üß≠ Sidebar -->
               <div class="col-md-3 col-lg-2 p-3 sidebar">

                    <form method="get">

                         <div class="mb-3">
                              <h6 class="mb-2"><strong>üéØ ‡∫™‡∫∞‡∫ñ‡∫≤‡∫ô‡∫∞‡∫ö‡∫±‡∫ô‡∫´‡∫≤:</strong></h6>
                              <div class="btn-group-vertical w-100">
                                   <a href="{% url 'problem_list' %}"
                                        class="btn btn-outline-dark btn-sm {% if not selected_status %}active{% endif %}">‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</a>
                                   <a href="?status=resolved{% if search_query %}&search={{ search_query }}{% endif %}"
                                        class="btn btn-outline-success btn-sm {% if selected_status == 'resolved' %}active{% endif %}">‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Ç‡ªÅ‡∫•‡ªâ‡∫ß‚úÖ ({{ resolved_count }})</a>
                                   <a href="?status=open{% if search_query %}&search={{ search_query }}{% endif %}"
                                        class="btn btn-outline-danger btn-sm {% if selected_status == 'open' %}active{% endif %}">‡∫ç‡∫±‡∫á‡∫ö‡ªç‡ªà‡∫ó‡∫±‡∫ô‡ªÅ‡∫Å‡ªâ‡ªÑ‡∫Çüü• ({{ open_count }})</a>
                              </div>
                         </div>

                         <!-- üóÇÔ∏è Filter by Priority -->
                         <div class="mb-3">
                              <h6 class="mb-2"><strong>üìå ‡∫à‡∫±‡∫î‡∫•‡∫Ω‡∫á‡∫•‡∫≥‡∫î‡∫±‡∫ö‡∫Ñ‡∫ß‡∫≤‡∫°‡∫™‡ªç‡∫≤‡∫Ñ‡∫±‡∫ô:</strong></h6>
                              <form method="get">
                                   <select name="priority" class="form-select" onchange="this.form.submit()">
                                        <option value="">‡∫ó‡∫±‡∫á‡ªù‡∫ª‡∫î</option>
                                        <option value="Critical" {% if selected_priority == "Critical" %}selected{% endif %}>‡∫™‡∫≥‡∫Ñ‡∫±‡∫ô</option>
                                        <option value="High" {% if selected_priority == "High" %}selected{% endif %}>‡∫™‡∫π‡∫á
                                        </option>
                                        <option value="Medium" {% if selected_priority == "Medium" %}selected{% endif %}>‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á</option>
                                        <option value="Low" {% if selected_priority == "Low" %}selected{% endif %}>‡∫ï‡ªç‡ªà‡∫≤
                                        </option>
                                   </select>
                              </form>

                         </div>

                         <!-- üì¶ Module Report -->
                         <div class="mb-3">
                              <h6 class="mb-2"><strong>üì¶ ‡ªÇ‡∫°‡∫î‡∫π‡∫ô‡∫û‡∫ª‡∫ö‡∫ö‡∫±‡∫ô‡∫´‡∫≤‡∫´‡∫º‡∫≤‡∫ç‡∫ó‡∫µ‡∫™‡∫∏‡∫î:</strong></h6>
                              <div class="dropdown">
                                   <button class="btn btn-outline-dark btn-sm dropdown-toggle w-100 text-start"
                                        type="button" id="moduleDropdown" data-bs-toggle="dropdown"
                                        aria-expanded="false">‡ªÄ‡∫•‡∫∑‡∫≠‡∫Å‡ªÇ‡∫°‡∫î‡∫π‡∫ô</button>
                                   <ul class="dropdown-menu w-100" aria-labelledby="moduleDropdown">
                                        {% for item in module_report %}
                                        <li>
                                             <a class="dropdown-item d-flex justify-content-between align-items-center {% if selected_module == item.module_module_name %}active{% endif %}"
                                                  href="?status={{ selected_status }}&priority={{ selected_priority }}&search={{ search_query }}&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}&module={{ item.module__module_name }}">
                                                  {{ item.module__module_name }}
                                                  <span class="badge bg-success rounded-pill">{{ item.count }}</span>
                                             </a>
                                        </li>
                                        {% endfor %}
                                   </ul>
                              </div>

                              <br>

                              <form method="get" class="mb-3">
                                   <label class="form-label small"><b>üìÖ Start Date:</b></label>
                                   <input type="date" name="start_date" class="form-control form-control-sm"
                                        value="{{ start_date }}">

                                   <label class="form-label small mt-2"><b>üìÖ End Date:</b></label>
                                   <input type="date" name="end_date" class="form-control form-control-sm"
                                        value="{{ end_date }}">

                                   <button type="submit" class="btn btn-outline-primary btn-sm mt-2 w-100">üîçFilter</button>
                              </form>

                              <!-- üîÑ Reset Button -->
                              <div class="d-grid">
                                   <a href="{% url 'problem_list' %}" class="btn btn-secondary btn-sm">üîÑ Reset Filters</a>
                              </div>

                              <br>

                              <a href="{% url 'export_problems_pdf' %}?status={{ selected_status }}&priority={{ selected_priority }}&search={{ search_query }}&start_date={{ start_date|default_if_none:'' }}&end_date={{ end_date|default_if_none:'' }}&module={{ selected_module }}" class="btn btn-outline-success btn-sm w-100 mt-2" target="_blank">
                              üìÑ Export Filtered to PDF
                              </a>

                         </div>

                    </form>

               </div>

               <!-- üìÑ Main Content Area -->
               <div class="col-md-9 col-lg-10 p-4">
                    <h5><b>‡∫ö‡∫±‡∫ô‡∫´‡∫≤‡∫ó‡∫µ‡ªÄ‡∫Ñ‡∫∑‡ªà‡∫≠‡∫ô‡ªÑ‡∫´‡∫ß‡∫•‡ªà‡∫≤‡∫™‡∫∏‡∫î:</b></h5>
                    <h6>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡∫ó‡∫±‡∫á‡ªú‡∫ª‡∫î: {{ total_issues }} ‡∫ö‡∫±‡∫ô‡∫´‡∫≤</h6>
                    <hr>

                    <!-- üìã Problem Table -->
                    <div class="table-responsive">
                         <table class="table table-striped" id="problemTable" style="table-layout: auto;">
                              <thead class="table-light">
                                   <tr>
                                        <th style="white-space: nowrap">Error Problem ID:</th>
                                        <th style="white-space: nowrap">Error Description:</th>
                                        <th style="white-space: nowrap">Error Details:</th>
                                        <th style="white-space: nowrap">Module:</th>
                                        <th style="white-space: nowrap">Status:</th>
                                        <th style="white-space: nowrap">Department:</th>
                                        <th style="white-space: nowrap">Last Updated:</th>
                                   </tr>
                              </thead>
                              <tbody id="problemTableBody">
                                   {% for problem in page_obj %}
                                   <tr>
                                        <td class="error-id-text">{{ problem.problem_id }}</td>
                                        <td class="error-description-text">
                                             <a href="{% url 'problem_detail' problem_id=problem.problem_id %}">
                                                  {{ problem.title }}
                                             </a>
                                        </td>

                                        <td class="text-wrap">{{ problem.description }}</td>

                                        <td>{{ problem.module.module_name }}</td>
                                        <td>{{ problem.status }}</td>
                                        <td>{{ problem.department.department_name }}</td>
                                        <td>{{ problem.updated_at|date:"SHORT_DATETIME_FORMAT" }}</td>
                                   </tr>
                                   {% empty %}
                                   <tr>
                                        <td colspan="8" class="text-center text-muted">‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</td>
                                   </tr>
                                   {% endfor %}
                              </tbody>
                         </table>
                    </div>

                    <!-- üî¢ Pagination -->
                    <nav aria-label="Page navigation">
                         <ul class="pagination justify-content-center">
                              {% if page_obj.has_previous %}
                              <li class="page-item">
                                   <a class="page-link"
                                        href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                                        ‚èÆÔ∏è ‡ªú‡ªâ‡∫≤‡∫Å‡ªà‡∫≠‡∫ô
                                   </a>
                              </li>
                              {% endif %}

                              {% for num in page_obj.paginator.page_range %}
                              <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                   <a class="page-link"
                                        href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                                        {{ num }}
                                   </a>
                              </li>
                              {% endfor %}

                              {% if page_obj.has_next %}
                              <li class="page-item">
                                   <a class="page-link"
                                        href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_priority %}&priority={{ selected_priority }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">
                                        ‡ªú‡ªâ‡∫≤‡∫ï‡ªç‡ªà‡ªÑ‡∫õ ‚è≠Ô∏è
                                   </a>
                              </li>
                              {% endif %}
                         </ul>
                    </nav>

               </div>

          </div>
     </div>

     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <script>
          $(document).ready(function () {
               $('#liveSearch').on('keyup', function () {
                    let query = $(this).val();

                    $.ajax({
                         url: window.location.href.split('?')[0],  // remove old query
                         data: { 'search': query },
                         headers: { 'X-Requested-With': 'XMLHttpRequest' },
                         success: function (data) {
                              let rows = '';
                              if (data.results.length === 0) {
                                   rows = `<tr><td colspan="8" class="text-center text-muted">‡∫ö‡ªç‡ªà‡∫û‡∫ª‡∫ö‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</td></tr>`;
                              } else {
                                   data.results.forEach(p => {
                                        rows += `
                                <tr>
                                    <td>${p.problem_id}</td>
                                    <td><a href="/problem/${p.problem_id}/">${p.title}</a></td>
                                    <td>${p.description}</td>
                                    <td colspan="5">...</td> <!-- fill extra columns as needed -->
                                </tr>
                            `;
                                   });
                              }
                              $('#problemTableBody').html(rows);
                         }
                    });
               });
          });
     </script>


     <script>
          const profileIcon = document.getElementById("profileIcon");
          const dropdown = document.getElementById("profileDropdown");

          profileIcon.addEventListener("click", () => {
               dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (event) => {
               if (!profileIcon.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = "none";
               }
          });

          function confirmLogout(event) {
               if (!confirm("Are you sure you want to log out?")) {
                    event.preventDefault();
               }
          }
     </script>

     <!-- üîí Logout Confirmation Modal -->
     <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered">
               <div class="modal-content">
                    <div class="modal-header">
                         <h5 class="modal-title" id="logoutModalLabel">‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫Å‡∫≤‡∫ô‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</h5>
                         <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∫õ‡∫¥‡∫î"></button>
                    </div>
                    <div class="modal-body">
                         ‡∫ó‡ªà‡∫≤‡∫ô‡ªÅ‡∫ô‡ªà‡ªÉ‡∫à‡∫ß‡ªà‡∫≤‡∫à‡∫∞‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö?
                    </div>
                    <div class="modal-footer justify-content-between">
                         <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">‡∫ç‡∫ª‡∫Å‡ªÄ‡∫•‡∫µ‡∫Å</button>
                         <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">‡∫≠‡∫≠‡∫Å‡∫à‡∫≤‡∫Å‡∫•‡∫∞‡∫ö‡∫ª‡∫ö</a>
                    </div>
               </div>
          </div>
     </div>

     {% if messages %}
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
     <link rel="stylesheet" href="{% static 'core/css/fonts.css' %}">

     {% for message in messages %}
     <script>
          Swal.fire({
               icon: 'success',
               text: "{{ message|escapejs }}",
               confirmButtonText: 'OK'
          });
     </script>
     {% endfor %}
     {% endif %}

     <script>
          function showLogoutModal(event) {
               event.preventDefault();
               const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
               modal.show();
          }
     </script>

     <!-- Scripts -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>